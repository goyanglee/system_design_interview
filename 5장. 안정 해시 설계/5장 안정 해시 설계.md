# 5장. 안정 해시 설계

수평적 규모 확작성을 달성하기 위해, 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다. 

안정해시는 이 목표를 달성하기 위해 보편적으로 사용하는 기술이다.

## 나오게 된 배경 : 해시 키 재배치(rehash)문제

N개의 캐시서버가 있을 때 균등하게 나누는 보편적 방법 : serverIndex = hash(key) % N(서버 개수)

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled.png)

: p78 그림 5-1

이 방법은 서버 풀의 크기가 고정되어 있을 때, 그리고 데이터 분포가 균등할 때 잘 동작하지만

서버가 추가되거나 기존 서버가 삭제되면 문제가 생긴다. 

서버1이 죽었을 때

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%201.png)

: p79그림 5-2

⇒ 대부분의 캐시의 키가 재분배 되고, 대부분의 캐시 클라이언트가 데이터가 없는 엉뚱한 서버에 도착하게 된다.

그 결과, 대규모 캐시미스(cache miss)가 발생한다. 

## 안정해시

위키디피아: 안정 해시는 해시 테이블 크기가 조정될 때 평균적으로 오직 k(키의 개수)/n(슬롯의 개수)개의 키만 재배치하는 해시기술이다. 

### 해시 공간과 해시 링

해시 함수 f로 SHA-1 을 사용하고, 그 함수의 출력 값 범위는 x0,x1 ... xn 일 때 

SHA-1의 해시 공간 범위는 0부터 2의 160제곱 -1 까지라고 알려져있다.

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%202.png)

P80. 그림 5-3

→  x0은 0, xn은 2의 160제곱 -1, x1부터 xn-1은 그 사이의 값을 표현한 그림, 그리고 그걸 구부리면 해시링

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%203.png)

P80. 그림 5-4

### 해시 서버

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%204.png)

P81. 그림 5-5

: 4개의 서버를 해시 링 위에 배치한다. 

### 해시 키

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%205.png)

P81. 그림 5-6

: 링 위의 어느 지점에 키를 배치한다. 

### 서버 조회

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%206.png)

P82. 그림 5-7

: 어떤 키가 저장되는 서버는, 해당 키의 위치로부터 시계 방향으로 링을 탐색해 만나는 첫 번째 서버다.

### 서버 추가

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%207.png)

P83. 그림 5-8

: 서버가 추가되더라도 키 가운데 일부만 재배치하면 된다. k0만 재배치 되었다. 

### 서버 제거

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%208.png)

P83. 그림 5-9

: 하나의 서버가 제거되면 키 가운데 일부만 재배치 된다. key1만 영향을 받는다.

### 기본 구현법의 두 가지 문제

안정 해시 알고리즘은 MIT에서 처음 제안되었다. 그 때 기본 절차는

- 서버와 키를 균등 분포(uniform distribution) 해시 함수를 사용해 해시 링에 배치한다.
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버다.

이 기본 절차의 두가지 문제점

- 서버가 추가되거나 삭제되는 상황을 감안하면 파티션(partition)의 크기를 균등하게 유지하는게 불가능하다.

> 파티션: 인접한 서버 사이의 해시공간
> 

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%209.png)

P84. 그림 5-10

: s1의 서버가 삭제되면 s2의 파티션이 다른 파티션 대비 거의 두 배로 커지는 상황을 보여준다.

- 키의 균등 분포(uniform distribution)를 달성하기가 어렵다.

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%2010.png)

P84. 그림 5-10

: s1과 s3는 아무 데이터도 갖지 않는 반면, 대부분의 키가 s2에 보관된다. 

### 해결책 : 가상 노드(virtual node) 또는 복제(replica)라 불리는 기법

가상 노드: 실제 노드 또는 서버를 가리키는 노드로서, 하나의 서버는 링 위에 여러개의 가상 노드를 가질 수 있다.

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%2011.png)

P86. 그림 5-12

: s0과 s1은 3개의 가상 노드를 갖는다. 여기서 3은 임의로 정한것이며 실제로는 훨씬 큰 값이 사용된다.

서버 0을 링에 배치하기 위해 s0_0,s0_1,s1_2의 세 개 가상 노드를 사용했다. 

따라서 각 서버는 하나가 아닌 여러 개 파티션을 관리해야 한다. 

 

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%2012.png)

P86. 그림 5-13

: 키의 위치로부터 시계 방향으로 링을 탐색하다 만나는 최초의 가상 노드가 해당 키가 저장될 서버다. 

가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등해진다. 표준편차가 작아져서 데이터가 고르게 분포되기 때문이다.

[https://tom-e-white.com/2007/11/consistent-hashing.html](https://tom-e-white.com/2007/11/consistent-hashing.html)에 따르면, 100~200개의 가상 노드를 사용했을 경우 표준 편차값은 5%(200개일 때) ~ 10%(100개일 때) 사이다. 

가상 노드의 개수를 더 늘리면 표준 편차값은 더 떨어지지만, 가상 노드 데이터를 저장할 공간은 더 많이 필요하게 된다.

⇒ 타협적 결정(trade off)가 필요하다는 뜻이다. 그러니 시스템 요구 사항에 맞도록 가상 노드 개수를 적절히 조정해야 할 것이다.

### 재배치할 키 결정

서버가 추가되거나 제거되면 데이터 일부는 재배치되어야 한다. 

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%2013.png)

P87. 그림 5-14

: s4가 추가되면, 영향을 받는것은 반시계 방향에 있는 첫번째 서버s3와의 사이이다. 그 사이에 있는 키들은 s4로 재배치 되어야 한다. 

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%92%E1%85%A2%E1%84%89%E1%85%B5%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20b85a895a6c9d42f88c21a6a13758337a/Untitled%2014.png)

P88. 그림 5-15

: s1이 삭제되면 s1의 반시계 방향에 있는 s0까지 사이의 키들이 s2로 재배치된다.

### 마치며

이번 장에서는 안정 해시가 왜 필요한가, 어떻게 동작하는지를 살펴보았다.

안정해시 이점

- 서버가 추가되거나 삭제될 때 재배치되는 키의 수가 최소화된다.
- 데이터가 보다 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다.
- 핫스팟 키 문제를 줄인다. 특정한 샤브에 대한 접근이 지나치게 빈번하면 서버 과부하 문제가 생길 수 있다.

안정해시가 실제로 쓰이는 기술 예시

- 아마존 다이나모 데이터베이스(DynamoDB)의 파티셔닝 관련 컴포넌트
- 아파치 카산드라(Apache Cassandra) 클러스터에서의 데이터 파티셔닝
- 디스코드(Discord) 채팅 어플리케이션
- 아카마이(Akamai) CDN
- 매그레프(meglev) 네트워크 부하 분산기